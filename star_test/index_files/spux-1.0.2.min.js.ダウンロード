/*
 spux-1.0.2.js
 Copyright (c) 2016 Rakuten.Inc
 Date: 2016-09-26 17:30:33
*/
Rmodules&&"function"==typeof Rmodules.define&&Rmodules.define(["jQuery","R^1","R.api^1"],function(a,b){function c(c,d){function e(a,b){return d?g(a,d.totalRate+(b||0)):void 0}function f(c){var d,f,g,h,i,j,k,l=a.extend({},A.display,c),m=a(l.parent).find(l.sDisplayElements).not("."+l.cDisplayedElements);for(j=0,k=m.length;k>j;j++)d=m.eq(j),g=d.data(l.dataPrice),h=d.data(l.dataExtraRate),i=d.data(l.dataCalculationType),f={"#ITEM_POINTS_AS_PRICE#":e(g,h,i)},d.html(b.applyTemplate(l.template,f)).addClass(l.cDisplayedElements);
return m}var g=b.getPointsFromRate||b.calculatePoints,h={data:d,Cases:x,type:c,getPoints:e,displayPoints:f};return c===x.ERROR?B.def.reject():B.def.resolve(h),a(A.css.sEventElem).trigger(A.global.componentEvent,h),h}function d(){return B.def.promise()}function e(a){var c=b.find(x,function(b){return b===a});return b.isString(c)?c.toLowerCase():""}function f(a,b,c){function d(){var b,c,d,e=[];for(c=0,d=a.sections.length;d>c;c++)(b.totalRate>0||A.sc.includeUnusedSections)&&e.push(A.sc.formatSection.replace(/#SECTION_ID#/g,b.id).replace(/#SECTION_NAME#/g,b.name).replace(/#SECTION_TOTALRATE#/g,b.totalRate));
return e.join(A.sc.formatSectionSeparator)}function f(){var b,c,d,e,f,g,h=[];for(d=0,e=a.sections.length;e>d;d++)for(b=a.sections[d],f=0,g=b.services.length;g>f;f++)c=b.services[f],(c.isQualified||A.sc.includeUnusedServices)&&h.push(A.sc.formatService.replace(/#SERVICE_ID#/g,c.id).replace(/#SERVICE_NAME#/g,c.name).replace(/#SERVICE_RATE#/g,c.rate).replace(/#SERVICE_QUALIFIES#/g,c.isQualified?1:0));return h.join(A.sc.formatServiceSeparator)}var g="",h="";return a&&(-1!==b.indexOf("#SERVICES#")&&(h=f()),
-1!==b.indexOf("#SECTIONS#")&&(g=d())),b.replace(/#TOTALRATE#/g,a?a.totalRate:0).replace(/#USERRANK#/g,a?a.getUserRankString():"na").replace(/#SOURCE#/g,A.spu.source.toLowerCase()).replace(/#VIEWTYPE#/g,A.spu.viewType.toLowerCase()).replace(/#CASE#/g,e(c)).replace(/#SECTIONS#/g,g).replace(/#SERVICES#/g,h)}function g(a,b,c,d){var e={};return e[a]=f(b,c,d),e}function h(b,c){A.sc.enabled&&(a(document).ready(function(){window.SC&&"function"==typeof window.SC.sendScDataOnLoad&&(window.SC.sendScDataOnLoad(b),
c&&(window.location=c))}),c&&window.setTimeout(function(){window.location=c},A.catalyst.send_link_timeout))}function i(a,b,c,d){function e(){return A.spu.itemId?[A.spu.shopId||"",A.spu.itemId].join("/"):""}var g,h,i,j,k,l,m={accountId:A.rat.accountId,serviceId:A.rat.serviceId,options:["url","ua"],pData:{itemId:e(),pgn:A.spu.viewType,pgl:A.spu.source,abtest:f(a,c,b)},cpData:{}};if(d&&(m.eventType=d),a)for(m.cpData.total=a.totalRate,g=0,h=a.sections.length;h>g;g++)if(i=a.sections[g],i.totalRate>0||A.rat.includeUnusedSections)for(m.cpData["sec_"+i.id]=i.totalRate,
j=0,k=i.services.length;k>j;j++)l=i.services[j],(l.isQualified||A.rat.includeUnusedServices)&&(m.cpData["srv_"+l.id]=l.rate);return m}function j(c){A.rat.enabled&&a(document).ready(function(){window.RAT&&b.isFunction(window.RAT.addCustomEvent)&&window.RAT.addCustomEvent(c)})}function k(a,c){var d=c.split(",");return-1!==b.find(d,function(c){return x[b.trim(c).toUpperCase()]===a})}function l(b,c){var d=!0;a(A.css.sTrackingClick).on("hover"===A.popup.displayOn?"mouseover":"click",function(){d&&(d=!1,
A.sc.sendShowEnabled&&k(b,A.sc.sendShowOn)&&h(g(A.sc.sendShowProp,c,A.sc.sendShowFormat,b)),A.rat.sendShowEnabled&&k(b,A.rat.sendShowOn)&&j(i(c,b,A.rat.sendShowCaseName,"hover"===A.popup.displayOn?"mouseover":void 0)))})}function m(a,c){var d={showDelay:A.popup.showDelay,hideDelay:A.popup.hideDelay,checkDelay:A.popup.checkDelay};k(a,A.popup.enableOn)&&("click"===A.popup.displayOn?b.enableOnClick(z.iconContainer,z.popupContainer,z.popupCloseButton,d):"hover"===A.popup.displayOn&&b.enableOnHover(z.iconContainer,z.popupContainer,d));
}function n(a){var b,c,d=A.css,e={};e[x.NOT_LOGGED]=d.sCaseNologin,e[x.NONE]=d.sCase1,e[x.NORMAL]=d.sCaseN,e[x.ERROR]=d.sCaseError,e[x.SUPER_DEAL]=d.sCaseSuperdeal,e[x.DISABLED]=d.sCaseDisabled,c="."+e[a].substring(1);for(b in z.templates)z.templates[b].not(c).remove()}function o(a,c){var d,e,f,g,h,i,j,k,l,m,n,o;if(c){for(n=A.global.disabledSections.split(","),j=0,k=n.length;k>j;j++)n[j]=b.trim(n[j]);for(o=A.global.disabledServices.split(","),j=0,k=o.length;k>j;j++)o[j]=b.trim(o[j]);for(d=z.templates[a],
j=0,k=d.length;k>j;j++)if(e=d.eq(j),f=e.find("."+A.css.cTemplateSection),f.length>0){for(g=f[0].outerHTML,l=0,m=c.sections.length;m>l;l++)i=c.sections[l],-1===n.indexOf(i.id)&&(A.global.showEmptySections||i.services.length>0)&&(h=p(g,i,o),(A.global.showEmptySections||h.nServices>0)&&f.before(h.$section));f.remove()}z.totalRate.html(c.totalRate)}}function p(c,d,e){var f,g,h,i,j,k,l={"#SECTION_ID#":d.id,"#SECTION_NAME#":b.truncate(d.name,A.global.sectionNameMaxLength),"#SECTION_FULLNAME#":d.name,"#SECTION_TOTALRATE#":d.totalRate
},m={$section:a(b.applyTemplate(c,l,!1)).removeClass(A.css.cTemplateSection),nServices:0};if(h=m.$section.find("."+A.css.cTemplateService),h.length>0){for(i=h[0].outerHTML,j=0,k=d.services.length;k>j;j++)g=d.services[j],-1===e.indexOf(g.id)&&(A.global.showEmptyServices||g.rate>0)&&(f=q(i,g),h.before(f),m.nServices++);h.remove()}return m}function q(c,d){var e,f={"#SERVICE_ID#":d.id,"#SERVICE_NAME#":b.truncate(d.name,A.global.serviceNameMaxLength),"#SERVICE_FULLNAME#":d.name,"#SERVICE_RATE#":d.rate,
"#SERVICE_LINK#":b.getTrackingLinks(d.link,A.sc)};"shopPoint"===d.id&&A.global.showShopDisclaimer&&(f["#SERVICE_NAME#"]+=A.global.shopDisclaimer),e=a(b.applyTemplate(c,f,!1)).removeClass(A.css.cTemplateService);var g,h,i,j,k,l=e.find("a");for(g=0,h=l.length;h>g;g++)j=a(l[g]),i=j.attr("href"),k=i.indexOf("http://",4),-1!==k&&j.attr("href",i.substring(k));return d.isQualified&&e.addClass(A.css.cServiceQualifies),d.link||e.find(A.css.sServiceLink).remove(),e}function r(a,b){var c,d,e,f,g,h;for(a.addClass(A.css.cTotalRate.replace(/#TOTAL_RATE#/g,b.totalRate)).addClass(A.css.cUserRank.replace(/#USER_RANK#/g,b.getUserRankString())),
c=0,e=b.sections.length;e>c;c++)for(d=b.sections[c],f=0,h=d.services.length;h>f;f++)g=d.services[f],g.isQualified&&a.addClass(A.css.cQualifiesService.replace(/#SERVICE_ID#/g,g.id))}function s(c){function d(a,b){var c,d;if(b.hasClass(A.css.cTogglerHidden)){for(c=0,d=o.length;d>c;c++)o.eq(c).addClass(A.css.cTogglerHidden);n.addClass(A.css.cTogglerHidden),a.removeClass(A.css.cTogglerHidden),b.removeClass(A.css.cTogglerHidden)}else a.addClass(A.css.cTogglerHidden),b.addClass(A.css.cTogglerHidden)}function e(a,b){
return function(){a.toggleClass(A.css.cTogglerHidden),b.toggleClass(A.css.cTogglerHidden)}}function f(a,b){return function(){d(a,b)}}var g,h,i,j,k,l,m,n=c.find(A.css.sSectionToggler),o=a();for(k=0,l=n.length;l>k;k++)g=n.eq(k),j=g.data("toggle"),j&&(h=c.find(j),o=o.add(h),"toggle"===A.popup.toggleType?g.click(e(g,h)):"accordion"===A.popup.toggleType&&g.click(f(g,h)));if("ALL"!==A.popup.toggleShow.toUpperCase())for(n.addClass(A.css.cTogglerHidden),o.addClass(A.css.cTogglerHidden),i=A.popup.toggleShow.split(","),
k=0,l=i.length;l>k;k++)b.isNumeric(i[k])?(m=parseInt(i[k],10)-1,n.eq(m).removeClass(A.css.cTogglerHidden),o.eq(m).removeClass(A.css.cTogglerHidden)):(o.filter('[data-toggle="'+i[k]+'"]').removeClass(A.css.cTogglerHidden),o.filter(i[k]).removeClass(A.css.cTogglerHidden))}function t(a){function b(a,b,c){var d=c.indexOf(a.id),e=c.indexOf(b.id);return-1===d&&(d=99999),-1===e&&(e=99999),d-e}function c(a,c){return b(a,c,g)}function d(a,c){return b(a,c,h)}var e,f,g=A.global.orderSections,h=A.global.orderServices;
if(g&&a.sections.sort(c),h)for(e=0,f=a.sections.length;f>e;e++)a.sections[e].services.sort(d)}function u(a,b){var e,f=z.iconContainer.add(z.popupContainer);return n(a),t(b),o(a,b),z.icon.children().appendTo(z.iconContainer),z.popup.children().appendTo(z.popupContainer),b&&r(f,b),m(a,b),s(z.popupContainer),l(a,b),e=c(a,b),f.data(A.global.componentData,{getData:d}),f.addClass(A.css.cReady),A.sc.sendDataEnabled&&h(g(A.sc.sendDataProp,b,A.sc.sendDataFormat,a)),A.rat.sendDataEnabled&&j(i(b,a,A.rat.sendDataCaseName)),
e}function v(){function b(a,b){var c,d;if(a){for(c in b)d=A.global.globalReplacement.replace("%",c.toUpperCase()),a=a.replace(new RegExp(d,"g"),b[c]);return a}}function c(b){var c,d,e;for(d=0,e=b.length;e>d;d++)c=a.extend(c,b.eq(d).data());return c||{}}var d,e,f,g=A.css,h={NOT_LOGGED:g.sCaseNologin,NONE:g.sCase1,NORMAL:g.sCaseN,ERROR:g.sCaseError,SUPER_DEAL:g.sCaseSuperdeal,DISABLED:g.sCaseDisabled},i=a(g.sIcon).last(),j=a(g.sPopup).last(),k=i.find('script[type="text/template"]'),l=j.find('script[type="text/template"]'),m=k.last().html(),n=l.last().html();
m=b(m,c(z.settings.find(y.config.templateIconData))),n=b(n,c(z.settings.find(y.config.templatePopupData))),d=a("<div>").append(m),e=a("<div>").append(n),k.remove(),l.remove(),z.iconContainer=i,z.popupContainer=j,z.icon=d,z.popup=e,z.totalRate=d.find(g.sTotalRate).add(e.find(g.sTotalRate)),z.popupCloseButton=d.find(g.s_popup_close_button).add(e.find(g.sPopupCloseButton)),z.templates={};for(f in h)z.templates[x[f]]=z.icon.find(h[f]).add(z.popup.find(h[f]));return z.icon.length&&z.iconContainer.length||z.popup.length&&z.popupContainer.length;
}function w(){if(A&&v())if(A.global.useTemplate)u(A.global.useTemplate);else if(b.user.isLogged(A.global.userLogged)){var c=a('[name="head"]').attr("name",null);b.api.spu.loadSpu(a.extend({},A.spu,{encoding:A.spu.encoding,sid:A.spu.sid,source:A.spu.source,viewType:A.spu.viewType,userRank:A.spu.userRank,itemId:A.spu.itemId,shopId:A.spu.shopId})).done(function(b){var c=u(1===b.totalRate?x.NONE:x.NORMAL,b);A.display.enabled&&(A.display.waitDom?a(c.displayPoints):c.displayPoints())}).fail(function(){
u(x.ERROR)}),c.attr("name","head")}else u(x.NOT_LOGGED)}var x={NOT_LOGGED:1,NONE:2,NORMAL:3,ERROR:4,SUPER_DEAL:5,DISABLED:6},y={config:{settingsContainer:".spux-settings",settingsGlobal:".spux-settings-global",settingsCss:".spux-settings-css",settingsSc:".spux-settings-sc",settingsRat:".spux-settings-rat",settingsSpu:".spux-settings-spu",settingsPopup:".spux-settings-popup",settingsDisplay:".spux-settings-display",templateIconData:".spux-template-icon-data",templatePopupData:".spux-template-popup-data"
},global:{enabled:[!0,"bool"],waitDom:[!1,"bool"],useTemplate:[void 0,"enumValue",x],sectionNameMaxLength:[64,"int"],serviceNameMaxLength:[64,"int"],disabledSections:["","str"],disabledServices:["","str"],orderSections:["","str"],orderServices:["","str"],userLogged:[void 0,"bool"],showEmptySections:[!1,"bool"],showEmptyServices:[!1,"bool"],componentData:["spux","str"],componentEvent:["spux-data-ready","str"],globalReplacement:["{{%}}","str"],showShopDisclaimer:[!1,"bool"],shopDisclaimer:['<span class="spux-shop-disclaimer">\uff08\u4e00\u90e8\u5546\u54c1\u306f\u5bfe\u8c61\u5916\u306e\u5834\u5408\u304c\u3042\u308a\u307e\u3059\uff09</span>',"str"]
},css:{sEventElem:[".spux-icon-container,.spux-popup-container","str"],sIcon:[".spux-icon-container","str"],sPopup:[".spux-popup-container","str"],sPopupCloseButton:[".spux-popup-close-button","str"],sCase1:[".spux-case-one","str"],sCaseN:[".spux-case-n","str"],sCaseError:[".spux-case-error","str"],sCaseSuperdeal:[".spux-case-superdeal","str"],sCaseNologin:[".spux-case-nologin","str"],sCaseDisabled:[".spux-case-disabled","str"],sTotalRate:[".spux-total-rate","str"],cTemplateSection:["spux-section-template","str"],
cTemplateService:["spux-service-template","str"],sServiceLink:[".spux-service-link-icon","str"],sSectionToggler:[".spux-section-header .spux-popup-arrow","str"],cTogglerHidden:["toggler-hidden","str"],sTrackingClick:[".spux-icon-container","str"],cReady:["spux-ready","str"],cTotalRate:["spux-totalrate-#TOTAL_RATE#"],cUserRank:["spux-user-rank-#USER_RANK#","str"],cQualifiesService:["spux-user-qualifies-#SERVICE_ID#","str"],cServiceId:["spux-service-id-#SERVICE_ID#","str"],cServiceQualifies:["spux-service-qualifies","str"]
},sc:{enabled:[!0,"bool"],addTrackingLink:[!0,"bool"],sid:["","str"],lid:["","str"],l2id:["","str"],sendDataEnabled:[!0,"bool"],sendDataProp:["prop16","str"],sendDataFormat:["spux_data:#VIEWTYPE#:#SOURCE#:#CASE#:#TOTALRATE#:#SERVICES#","str"],sendShowEnabled:[!0,"bool"],sendShowOn:[void 0,"str"],sendShowProp:["prop18","str"],sendShowFormat:["spux_show:#VIEWTYPE#:#SOURCE#:#CASE#:#TOTALRATE#:#SERVICES#","str"],includeUnusedSections:[!1,"bool"],includeUnusedServices:[!1,"bool"],formatSection:["#SECTION_ID#-#SECTION_TOTALRATE#","str"],
formatSectionSeparator:[";","str"],formatService:["#SERVICE_ID#-#SERVICE_RATE#","str"],formatServiceSeparator:[";","str"],sendLinkTimeout:[3e3,"int"]},rat:{enabled:[!0,"bool"],accountId:[459,"int"],serviceId:[1,"int"],sendDataEnabled:[!0,"bool"],sendDataCaseName:["spux_data:#VIEWTYPE#:#SOURCE#:#CASE#","str"],sendShowEnabled:[!0,"bool"],sendShowOn:[void 0,"str"],sendShowCaseName:["spux_show:#VIEWTYPE#:#SOURCE#:#CASE#","str"],includeUnusedSections:[!0,"bool"],includeUnusedServices:[!1,"bool"]},spu:{
sid:[void 0,"enumValue",b.api.spu.ServiceId],source:[void 0,"enumValue",b.api.spu.Source],viewType:[void 0,"enumValue",b.api.spu.ViewType],userRank:[void 0,"enumValue",b.api.spu.UserRank],itemId:[void 0,"str"],shopId:[void 0,"str"],encoding:[b.api.spu.Encoding.EUC_JP,"enumValue",b.api.spu.Encoding]},popup:{enableOn:["NORMAL","str"],displayOn:[b.browser.isMobile?"click":"hover","str"],showDelay:[0,"int"],hideDelay:[0,"int"],checkDelay:[300,"int"],toggleType:["toggle","str"],toggleShow:["all","str"]
},display:{enabled:[!0,"bool"],waitDom:[!1,"bool"],parent:["body","str"],template:["<span>#ITEM_POINTS_AS_PRICE#</span>","str"],dataPrice:["price","str"],dataExtraRate:["extraRate","str"],dataCalculationType:["type","str"],sDisplayElements:[".spux-display-formatted","str"],cDisplayedElements:["spux-display-formatted-ready","str"]}},z={},A=function(){var c,d=a(y.config.settingsContainer).last();return 0===d.length?null:(z.settings=d,c={global:b.readSettings(d.find(y.config.settingsGlobal),y.global),
css:b.readSettings(d.find(y.config.settingsCss),y.css),sc:b.readSettings(d.find(y.config.settingsSc),y.sc),rat:b.readSettings(d.find(y.config.settingsRat),y.rat),spu:b.readApiSettings(d.find(y.config.settingsSpu),y.spu),popup:b.readSettings(d.find(y.config.settingsPopup),y.popup),display:b.readSettings(d.find(y.config.settingsDisplay),y.display)},void 0===c.global.showShopDisclaimer&&(c.global.showShopDisclaimer=c.spu.viewType===b.api.spu.ViewType.CATEGORY),void 0===c.sc.sendShowOn&&(c.sc.sendShowOn=c.popup.enableOn),
void 0===c.rat.sendShowOn&&(c.rat.sendShowOn=c.popup.enableOn),c)}(),B={def:a.Deferred(),data:null};A.global.enabled&&(A.global.waitDom?a(w):w())});
