/*
 all_shops_recommend-1.3.1.js
 Copyright (c) 2018 Rakuten.Inc
 Date: 2018-03-08 10:08:15
*/
Rmodules.define(["jQuery","R^1","R.api.top^1","R.ui^1"],function(a,b){function c(c){function d(b){a.each(b.getItems(),function(a,b){var c=b.find(l.css.shopLogo),d=b.find(l.css.shopNoLogo),e=new Image;e.onload=function(){1===e.width?(c.remove(),d.show()):(c.show(),d.remove()),e.onload=null},e.onerror=function(){c.remove(),d.addClass("visible"),e.onload=null},e.setAttribute("src",c.find("img").attr("data-r-src"))})}var e;if(!c.itemTemplate.data.length)return k.hide(),!1;var f={hideOnEmpty:j,
hideOnMin:l.global.minItems,imageLazyLoad:"data-r-src",itemAlign:b.ui.Slideshow.ItemAlign.LEFT,scrollLoop:b.ui.Slideshow.ScrollLoop.HARD};return l.global.hideShopTitle||l.global.forceTextShopTitle||(f.beforeFirstRender=d),l.global.pagination||(f.noPagination=!0,f.scrollMode="SIMPLE"),l.global.mobile&&(f=a.extend(!0,b.ui.Slideshow.getSpOptions(),f)),k.html(j.html()).show(),e=k.find(l.css.slideshowSelector).children("div"),new b.ui.Slideshow(e,c,f)}function d(a){var c=l.global.imageDimensions.split(":"),d={
width:c[0],height:c[1],asString:!0},e=a.getItemImageUrl(),f=!!e;f||(e=l.global.nopictureImg);var g=f&&-1===e.indexOf("//www.rakuten.co.jp/com/img/"),h=l.global.useTshop,i=g?a.getItemThumbnail(d.width,d.height):e,j=g?a.getItemThumbnailSet(d):"";!f||g&&h||(i=a.getItemImageUrl(d.width,d.height),j=a.getItemImageSet(d));var k=a.getItemReviewNumber()>=l.global.minReviews&&a.getItemReviewAverage()>l.global.minReviewAverage,m=k?b.display.reviewAverageStars(a.getItemReviewAverage()):!1,n=b.getTrackingLinks(a.getShopUrl(),l.global),o=b.getTrackingLinks(a.getItemUrl(),l.global);
return l.global.forceProtocol&&(n=l.global.forceProtocol+":"+n),{"#ITEMTITLE#":b.truncate(a.getItemName(),l.global.itemNameMaxLength),"#ITEMIMG#":i,"#ITEMIMGSET#":j,"#ITEMHREF#":o,"#SHOPHREF#":n,"#SHOPNAME#":b.truncate(a.getShopName(),l.global.shopNameMaxLength),"#SHOPIMG#":a.getShopLogoUrl("2n"),"#ITEMPRICE#":b.display.formatPrice(a.getItemPrice()),"#ITEMSHIPPING#":b.display.shippingIncludedText(a.isItemShippingIncluded()),"#ITEMSTARS#":m&&m.get(0).outerHTML||"","#ITEMREVIEWS#":k?b.display.formatNumber(a.getItemReviewNumber()):"",
"#REVIEWSHREF#":a.getItemReviewUrl(),"#SHOWREVIEWS#":k?"":"hide"}}function e(a,b){var c,e=[],f=l.global.maxItems?Math.min(l.global.maxItems,a.length):a.length;l.global.enableApiLid&&b.lid&&b.lid===l.global.abTestShowShopLogoValue&&(l.global.hideShopTitle=!1,l.global.forceTextShopTitle=!1),l.global.hideShopTitle&&m.find(".r-slideshow-item-header").remove(),l.global.forceTextShopTitle&&(m.find(l.css.shopLogo).remove(),m.find(l.css.shopNoLogo).addClass("visible")),c=m.html();var g=/href="[^\#]([^\'\"]+)/g;
c=c.replace(g,function(a,b){var c=b.indexOf("#");return-1!==c&&0!==c?'href="'+b.substr(c)+'"':a});for(var h=0;f>h;h++)e.push(d(a[h]));return{itemWidth:l.global.itemWidth,itemTemplate:{html:c,data:e,escapeData:!1}}}function f(a){var c,d,e=[];if(!(a.length<1)){for(c=0,d=a.length;d>c;c++)e.push(a[c].getShopId()+"/"+a[c].getItemId());var f={accountId:l.rat.accountId,serviceId:l.rat.serviceId,options:["url","ua"],pData:{pgn:b.browser.isMobile?l.rat.pageNameSp:l.rat.pageNamePc,itemid:e}};b.sendToRat(f);
}}function g(){return b.user.isLogged(l.global.userLogin)?(b.setMockupApiUrl(l.global.mockApi),void(l.global.lazyLoadWidget&&k.length?b.onLazyLoad(h,"all-shops-recommend-lazy",k,l.global.lazyLoadOffset):h())):void k.hide()}function h(){b.offLazyLoad("all-shops-recommend-lazy");var d=a('[name="head"]').attr("name",null);b.api.itemRecommendation.loadUserBasedRecommendedItems(l.allShopsRecommend).done(function(a,b){f(a),c(e(a,b))}).fail(function(){k.hide()}),d.attr("name","head")}var i={config:{elemId:"#allShopsRecommendWidget",
templateId:"#allShopsRecommendWidgetTemplate",settings:".all-shops-recommend-settings",settingsCss:".all-shops-recommend-settings-css",settingsApi:".all-shops-recommend-settings-api",settingsRat:".all-shops-recommend-settings-rat"},global:{enabled:[!0,"bool"],waitDom:[!1,"bool"],mockApi:["","str"],itemWidth:[140,"int"],itemHeight:[140,"int"],itemNameMaxLength:[25,"int"],shopNameMaxLength:[0,"int"],minItems:[1,"int"],maxItems:[20,"int"],userLogin:[void 0,"bool"],mobile:[void 0,"bool"],sid:["","str"],
lid:["","str"],l2id:["","str"],rat:[void 0,"str"],pagination:[!0,"bool"],imageDimensions:["130:130","str"],minReviews:[void 0,"int"],minReviewAverage:[void 0,"float"],hideShopTitle:[!1,"bool"],forceTextShopTitle:[!1,"bool"],lazyLoadWidget:[!0,"bool"],enableApiLid:[!0,"bool"],abTestShowShopLogoValue:["3","str"],lazyLoadOffset:[600,"int"],useTshop:[!0,"bool"],forceProtocol:[void 0,"str"],nopictureImg:["https://r.r10s.jp/com/css/c/pc/img/nopicture/nopicture.gif?fitin=140:140","str"]},css:{slideshowSelector:["#allShopsRecommendSlideshow"],
itemTemplateSelector:["#allShopsRecommendItemTemplate"],shopLogo:[".shop-has-logo"],shopNoLogo:[".shop-has-no-logo"]},allShopsRecommend:{sid:["test","str"],itemId:["","str"],lid:["","str"]},rat:{accountId:[470,"int"],serviceId:[1,"int"],pageNamePc:["itempage_pc","str"],pageNameSp:["itempage_sp","str"]}},j=a(a(i.config.templateId).html()),k=a(i.config.elemId),l=function(){var a=j.find(i.config.settings),c={global:b.readSettings(a,i.global),css:b.readSettings(a.find(i.config.settingsCss),i.css),rat:b.readSettings(a.find(i.config.settingsRat),i.rat),
allShopsRecommend:b.readApiSettings(a.find(i.config.settingsApi),i.allShopsRecommend)};return void 0===c.global.mobile&&(c.global.mobile=b.browser.isMobile||b.browser.isIchibaApp),void 0===c.global.minReviews&&(c.global.minReviews=c.global.mobile?0:3),void 0===c.global.minReviewAverage&&(c.global.minReviewAverage=c.global.mobile?0:-1),c}(),m=j.find(l.css.itemTemplateSelector).removeClass(l.css.itemTemplateSelector.substring(1)).remove();l.global.enabled&&(l.global.waitDom?a(g):g())});
